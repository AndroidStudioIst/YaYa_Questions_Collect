## 大文件传输相关知识整理
> 作者 : monsterlin
>
> 时间 : 2017-09-02

### 写在前面

或许你使用过百度云秒传，或者说是QQ秒传，这类的秒传的基本原因基本都是在你进行文件传输的过程中进行服务器资源检测，如果服务器存在该资源，那么说就把当前用户上传的资源对已有资源建立一个关系，同而实现秒传的功能，在这个过程涉及到复杂的资源检测操作，以及相应的MD5加密操作

由于本人没有参与过相关的代码涉及以及团队的研发对这类秒传有些自己的猜想：
- 由于地域问题，那么说为了提高传输速度，首先会在距离用户最近的CDN节点进行传输
- 在进行资源比对的过程，不单单是一个资源名称的对比，内部具体涉及到对资源内容的对比，进而再高准确率的前提下达到秒传的目的，这其中必定涉及复杂的算法
- 在文件传输中，必然对用户资源的安全做一个高强度的加密，以防止其对资源进行劫持

### Socket进行文件传输

-  socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信
-  socket其实也是一样的东西，就是提供了tcp/ip协议的抽象，对外提供了一套接口，同过这个接口就可以统一、方便的使用tcp/ip协议的功能了

![socket](http://images2015.cnblogs.com/blog/733402/201601/733402-20160106213656075-1895373856.png)

以上进行了socket特点的展示，那么对于大文件的传输，一种方案就是：`采用socket长连接的方式，直接读流，写流`，以上方案来自[angcyo](https://github.com/angcyo)

#### 什么是长连接？

socket长连接其实是长时间保持服务端与客户端的连接，这是相对于短连接而言。`只要你两端不主动断开连接，那么该socket连接就是一直存在的，就可以收发数据`。如果做得合理一点，就是在你不发数据的时候，自定义一个检测数据包（我们可以称之为`心跳`），例如由客户端定时主动给服务端发送，这样服务端收到后就表明，该连接时一直保持的。直到你主动关闭一端，该连接才断开。

#### 长连接涉及的问题：

如果`流一直可用，而且没有读到流的末尾（就是对应着对方流已经关闭或者网络断开！），read会一直阻塞`！其实这样做也是可以解释清楚的：本来服务端的read方法就不知道Server端的消息`什么时候发送完`，说不定我以为数据发送完 了，但其实是因为`网络延迟`而导致部分数据延后到来（况且也不可能所有数据同时到达），所以，read方法只能`一直在阻塞`等待对方的应答

#### 正确实现长连接：

- 客户端自动退出开读取的动作：`退出动作`必须有`客户端程序自己完成`，我们可以在`服务端没发送完一段消息`并且`刷新前`就进行一个`写入结束符号`的标志，客户端`解析到结束符号`时，变可直接`退出read的`循环读取操作，避免一直阻塞
- 可以调用有读取`一定字节`到某个数组的read方法（不过好像这个不太行，毕竟每次消息的长度好像会变的），当然，这`只是针对消息定长`的情况

#### 参考资料：
- [最近做socket保持长连接的一些心得](http://blog.csdn.net/arvinstudy/article/details/8625523)
- [Socket的长连接和短连接](http://www.cnblogs.com/lcplcpjava/p/6581179.html)

### 大文件传输性能优化

- 大文件必须走流方式
- 为了提高效率，分片多线程
- 为了提高体验，同时加断点

对于分片多线程，这其中涉及到OSI模型中的传输层的相关知识以及java中的线程知识，具体可自行研究

这个加断点，其实也就是所谓的断点续传，具体可以参考以下链接

#### 参考资料
- [应用系统之间数据传输的几种方式](http://www.cnblogs.com/aigongsi/archive/2012/04/26/2413646.html)
- [文件断点续传原理与实现](http://blog.csdn.net/zdy0_2004/article/details/41814651)
- [分片](https://baike.baidu.com/item/%E5%88%86%E7%89%87/13677994?fr=aladdin)
- [断点续传](https://baike.baidu.com/item/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0)
